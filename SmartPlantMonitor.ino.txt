/*
SmartPlantMonitor.ino
Simple smart plant watering controller for Arduino Uno (or compatible)

Features:
- Reads soil moisture (analog sensor)
- Reads temperature & humidity using DHT11/DHT22
- Controls a relay to switch a water pump
- Uses threshold + hysteresis + max pump run and cooldown interval to prevent over-watering
- Serial output for monitoring and calibration

Hardware:
- Arduino Uno (or Nano)
- Soil moisture sensor (analog)
- DHT11 or DHT22
- Relay module (for pump) -- make sure pump power is separate from Arduino and proper flyback/protection used
- 12V (or appropriate) pump
- Optional: LED for pump state

Library:
- DHT sensor library by Adafruit (install via Library Manager)

Wiring (example):
- Soil sensor analog out -> A0
- DHT data -> digital pin 2 (with 10K pull-up if needed)
- Relay signal -> digital pin 8
- Relay Vcc/GND -> 5V/GND
- Pump + relay: Pump power supply -> relay COM, relay NO -> pump, other pump terminal -> power supply ground
  (Follow relay wiring guide and safety precautions.)

Calibration hints:
- With sensor in dry air, note analog reading (sensorDry)
- With sensor in wet soil, note analog reading (sensorWet)
- Plug these values into sensorDry/sensorWet constants below to improve accuracy

Author: Copied/generated for yashrahangdale102
*/

#include <DHT.h>

// ===== CONFIG =====
const int soilPin = A0;           // analog pin for soil moisture
const int relayPin = 8;           // relay control pin (digital)
const int dhtPin = 2;             // DHT data pin
#define DHTTYPE DHT22             // change to DHT11 if using DHT11

// Calibration: measure sensor analog value when completely wet and completely dry
// Replace these with your measured values for best results
const int sensorWet = 300;        // analog reading when sensor is saturated with water
const int sensorDry = 700;        // analog reading when sensor is dry

// Control thresholds
const float moistureThreshold = 40.0;   // moisture percent below which pump should run
const float hysteresis = 4.0;           // percent hysteresis to avoid rapid toggles

// Pump safety & timing
const unsigned long pumpDurationMs = 15UL * 1000UL;     // how long to run pump each watering (ms). Default 15s
const unsigned long pumpCooldownMs = 30UL * 60UL * 1000UL; // minimum time between watering cycles (ms). Default 30 minutes

// ===== END CONFIG =====

DHT dht(dhtPin, DHTTYPE);

bool pumpOn = false;
unsigned long pumpStartMillis = 0;
unsigned long lastWaterMillis = 0;  // time when pump was last turned off

void setup() {
  Serial.begin(115200);
  delay(100);
  Serial.println(F("Smart Plant Monitor starting..."));

  pinMode(soilPin, INPUT);
  pinMode(relayPin, OUTPUT);
  // Make sure relay is off at startup
  digitalWrite(relayPin, HIGH); // Many relay modules are active LOW. If yours is active HIGH, change to LOW here.
  // If your relay is active HIGH, set RELAY_ACTIVE_LOW = false and invert writes (see comment below).

  dht.begin();
  Serial.println(F("DHT started"));
  Serial.println();
}

void loop() {
  unsigned long now = millis();

  // Read sensors
  int rawSoil = analogRead(soilPin);
  float moisture = soilPercentFromAnalog(rawSoil); // 0..100 (100 = very wet)
  float temperature = NAN;
  float humidity = NAN;
  // Read DHT (avoid reading too frequently)
  static unsigned long lastDhtRead = 0;
  static float lastTemp = NAN;
  static float lastHum = NAN;
  if (now - lastDhtRead > 2000) { // every 2s
    lastDhtRead = now;
    humidity = dht.readHumidity();
    temperature = dht.readTemperature();
    if (!isnan(humidity)) lastHum = humidity;
    if (!isnan(temperature)) lastTemp = temperature;
  } else {
    humidity = lastHum;
    temperature = lastTemp;
  }

  // Decide whether to water:
  // Two-stage logic using hysteresis and cooldown:
  // - If moisture < threshold and cooldown passed -> start pump for pumpDuration
  // - Once pump started, run for pumpDuration then turn off and record lastWaterMillis
  // - While moisture > (threshold + hysteresis) do nothing
  if (pumpOn) {
    // check if it's time to stop
    if (now - pumpStartMillis >= pumpDurationMs) {
      stopPump();
      lastWaterMillis = now;
    }
  } else {
    bool cooldownOk = (now - lastWaterMillis) >= pumpCooldownMs;
    if (moisture < moistureThreshold && cooldownOk) {
      startPump();
    } else {
      // nothing to do
    }
  }

  // Print status to serial for monitoring/calibration
  Serial.print(F("Soil raw: "));
  Serial.print(rawSoil);
  Serial.print(F(" -> "));
  Serial.print(moisture, 1);
  Serial.print(F("%"));
  Serial.print(F("  | Temp: "));
  if (!isnan(temperature)) {
    Serial.print(temperature, 1);
    Serial.print(F("C"));
  } else Serial.print(F("N/A"));
  Serial.print(F("  | Hum: "));
  if (!isnan(humidity)) {
    Serial.print(humidity, 1);
    Serial.print(F("%"));
  } else Serial.print(F("N/A"));
  Serial.print(F("  | Pump: "));
  Serial.println(pumpOn ? "ON" : "OFF");

  delay(1500);
}

float soilPercentFromAnalog(int analogValue) {
  // convert analog reading to percent between 0 and 100
  // note: depending on your sensor wiring, wet may be lower or higher reading.
  // This function assumes sensorWet < sensorDry (wet gives smaller analog value).
  int v = analogValue;
  // protect against inverted calibration
  int wet = sensorWet;
  int dry = sensorDry;
  if (wet == dry) return 0.0;
  float pct;
  if (wet < dry) {
    // map wet->100, dry->0
    pct = 100.0 * (float)(dry - v) / (float)(dry - wet);
  } else {
    // mapping if sensorWet > sensorDry (some modules behave differently)
    pct = 100.0 * (float)(v - dry) / (float)(wet - dry);
  }
  if (pct < 0.0) pct = 0.0;
  if (pct > 100.0) pct = 100.0;
  return pct;
}

void startPump() {
  Serial.println(F("Starting pump..."));
  // Most common relay modules are active LOW. If yours is active HIGH, use digitalWrite(relayPin, HIGH);
  digitalWrite(relayPin, LOW); // LOW -> energize relay (turn pump ON) for active-LOW modules
  pumpOn = true;
  pumpStartMillis = millis();
}

void stopPump() {
  Serial.println(F("Stopping pump..."));
  // Turn relay off
  digitalWrite(relayPin, HIGH); // HIGH -> de-energize relay (pump OFF) for active-LOW modules
  pumpOn = false;
}

/*
Notes & Safety:
- Make sure the pump motor current & voltage are powered separately and the relay used is rated for the pump's current.
- For mains-powered pumps, follow electrical safety rules and isolate the microcontroller when working with high voltages.
- Use proper waterproofing for soil probes and avoid galvanic corrosion (use probes as electrodes carefully).
- For long-term deployment, consider adding a water level sensor to avoid running the pump dry.
- Adjust sensorWet and sensorDry according to calibration values you measure.
- Adjust moistureThreshold, pumpDurationMs, and pumpCooldownMs to suit your plant and pot size.
*/